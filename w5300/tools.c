#include<c8051F340.h>

extern unsigned char idata temp[];

unsigned char code U1000[]={
	0x00,0x00,0x00, 0x96,0x40,0x00, 0x92,0x81,0x00, 0x88,0x22,0x01,
	0x84,0x63,0x01, 0x80,0x04,0x02, 0x76,0x45,0x02, 0x72,0x86,0x02,
	0x68,0x27,0x03, 0x64,0x68,0x03, 0x60,0x09,0x04, 0x56,0x50,0x04,
	0x52,0x91,0x04, 0x48,0x32,0x05, 0x44,0x73,0x05, 0x40,0x14,0x06
};
unsigned char code U0100[]={
	0x00,0x00,0x56,0x02,0x12,0x05,0x68,0x07,0x24,0x10,0x80,0x12,0x36,0x15,0x92,0x17,
	0x48,0x20,0x04,0x23,0x60,0x25,0x16,0x28,0x72,0x30,0x28,0x33,0x84,0x35,0x40,0x38
};
unsigned char code U0010[]={
	0x00,0x00,0x16,0x00,0x32,0x00,0x48,0x00,0x64,0x00,0x80,0x00,0x96,0x00,0x12,0x01,
	0x28,0x01,0x44,0x01,0x60,0x01,0x76,0x01,0x92,0x01,0x08,0x02,0x24,0x02,0x40,0x02
};

//-----------------------------------------------------------------------------
//Chang HEX data to BCD format
//-----------------------------------------------------------------------------
unsigned int BCD_add(unsigned char i,unsigned char j)
{
	unsigned int k;

	k=0;
	i=i+(j&0x0f);

	if(PSW&0x40)
		i+=0x06;
	else{
		if((i&0x0f)>9)
			i+=6;
		if((i&0xf0)>0x90){
			i+=0x60;
			k=0x0100;
		}
	}

	i=i+(j&0xf0);
	if(PSW&0x80){
		i+=0x60;
		k=0x0100;
	}
	else if((i&0xf0)>0x90){
		i+=0x60;
		k=0x0100;
	}

	k+=i;

	return k;
}

void Hex_TO_Dec(unsigned int x)
{
	unsigned char i,j,k;
	unsigned char l;
	unsigned int m;

	l=x>>8;
	l>>=4;
	l*=3;
	i=U1000[l++];
	j=U1000[l++];
	k=U1000[l];

	l=x>>8;
	l&=0x0f;
	l<<=1;

	m=BCD_add(i,U0100[l++]);
	i=m;
	if(m&0x0100){
		m=BCD_add(j,1);
		j=m;
		if(m&0x0100){
			m=BCD_add(k,1);
			k=m;
		}
	}
	m=BCD_add(j,U0100[l]);
	j=m;
	if(m&0x0100){
		m=BCD_add(k,1);
		k=m;
	}

	l=x;
	l&=0xf0;
	l>>=3;
	m=BCD_add(i,U0010[l++]);
	i=m;
	if(m&0x0100){
		m=BCD_add(j,1);
		j=m;
		if(m&0x0100){
			m=BCD_add(k,1);
			k=m;
		}
	}
	m=BCD_add(j,U0010[l]);
	j=m;
	if(m&0x0100){
		m=BCD_add(k,1);
		k=m;
	}

	l=x;
	l&=0x0f;
	if(l>9)
		l+=6;
	m=BCD_add(i,l);
	i=m;
	if(m&0x0100){
		m=BCD_add(j,1);
		j=m;
		if(m&0x0100){
			m=BCD_add(k,1);
			k=m;
		}
	}
	temp[0]=i;
	temp[1]=j;
	temp[2]=k;
}

//-----------------------------------------------------------------------------
//Change Dec to Hex
//-----------------------------------------------------------------------------
unsigned int Dec_TO_Hex(unsigned char k,unsigned int x)
{
	unsigned char i;
	unsigned int j;

	i=k&0x0f;
	j=i*10000;

	k=x>>8;
	i=k;
	i>>=4;
	j=j+i*1000;

	i=k;
	i&=0x0f;
	j=j+i*100;

	k=x;
	i=k;
	i=i>>4;
	j=j+i*10;

	i=x&0x0f;
	j+=i;
	return j;
}